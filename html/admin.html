<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<title>Admin - Diaporama Réponses</title>
<style>
/* Styles essentiels pour la page */
html, body { height: 100%; margin: 0; background: #000; color: #fff; }

/* Nouveau style pour le conteneur du diaporama */
#diapo-content-wrapper {
    /* Utilise toute la hauteur disponible moins la barre de navigation */
    height: calc(100vh - 56px); 
    display: flex;
    justify-content: center; 
    align-items: center;
    padding: 20px;
    width: 100%;
}
#diapo-content {
    /* Conteneur pour le contenu de la slide (permet la transition d'opacité) */
    display: flex;
    justify-content: center;
    align-items: center;
    width: 80%; /* Donne de l'espace aux boutons de navigation */
    height: 100%;
    transition: opacity 0.5s ease-in-out; /* Ajout d'une transition pour l'effet */
}

/* Styles pour les éléments de la slide */
.slide-item { 
    max-height: 90%; 
    overflow-y: auto;
    width: 100%;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* Styles spécifiques au contenu */
h2 { font-size: 2.5rem; margin-bottom: 1rem; }
p { font-size: 1.8rem; margin-bottom: 1rem; }
.separator { font-size: 3rem; font-weight: bold; }

/* Styles pour les boutons de navigation (Positionnement sur les bords) */
.nav-button {
    font-size: 2rem;
    padding: 1rem 1.5rem;
    height: 100%; 
    background: none;
    border: none;
    color: #fff;
    opacity: 0.5;
    transition: opacity 0.3s;
    position: absolute; 
    top: 0;
    z-index: 10;
}
.nav-button:hover {
    opacity: 1;
}
#nav-prev { left: 0; }
#nav-next { right: 0; }
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary px-3">
    <span class="navbar-brand">Espace Admin</span>
    <button class="btn btn-light ms-2" onclick="toggleFullscreen()">Plein écran</button>
</nav>

<div id="diapo-content-wrapper">
    
    <button id="nav-prev" class="nav-button" onclick="handleManualNavigation(-1)">
        &lsaquo;
    </button>
    
    <div id="diapo-content">
        <h1>Chargement des données...</h1>
    </div>
    
    <button id="nav-next" class="nav-button" onclick="handleManualNavigation(1)">
        &rsaquo;
    </button>
    
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- VÉRIFICATION DE SÉCURITÉ ---
if (sessionStorage.getItem('isAdmin') !== 'true') {
    window.location.href = "admin-login.html";
}
sessionStorage.removeItem('isAdmin'); 

// --- VARIABLES GLOBALES ---
const zones = [1, 2];
const questions = ["q1","q2","q3","q4"];
const TRANSITION_DURATION_MS = 500; 

let slideDefinitions = [];      // Tableau des définitions de slides (ID + Type)
let currentSlide = 0;           // Index de la slide actuellement affichée (dans slideDefinitions)
let currentResponseIndex = {};  // { 'zone_question': index_reponse_visible }
let rawData = {};               // { 'zone_question': [reponses brutes] }

// --- FONCTIONS ESSENTIELLES ---

function toggleFullscreen() {
    const elem = document.documentElement; 
    if (!document.fullscreenElement) elem.requestFullscreen();
    else document.exitFullscreen();
}

/**
 * Récupère les données brutes du localStorage et remplit le tableau 'slideDefinitions'.
 */
function generateSlideDefinitions() {
    slideDefinitions = []; 

    zones.forEach(zone => {
        // 1. Slide séparateur (Situation)
        slideDefinitions.push({ type: 'separator', id: `sep_${zone}`, zone: zone });

        questions.forEach(q => {
            const key = `${zone}_${q}`;
            const allResponses = JSON.parse(localStorage.getItem(key)) || []; 
            
            // Stocke les données brutes
            rawData[key] = allResponses.filter(r => r && r.trim() !== ""); 
            
            if (rawData[key].length > 0) {
                // Initialise l'index de réponse pour cette question à 0 si non défini
                if (currentResponseIndex[key] === undefined) {
                    currentResponseIndex[key] = 0; 
                }
                
                // 2. Slide Question/Réponse
                slideDefinitions.push({ type: 'question', id: key, zone: zone, question: q });
            }
        });
    });
    
    // S'assurer que l'index reste valide
    if (currentSlide >= slideDefinitions.length) {
        currentSlide = 0;
    }
}

/**
 * Génère le HTML pour la slide actuellement définie (ID, index de réponse).
 */
function generateSlideHTML(slideDef) {
    const { type, id, zone, question } = slideDef;
    
    if (type === 'separator') {
        return `<div class="slide-item"><div class="separator">Situation ${zone}</div></div>`;
    }

    if (type === 'question') {
        const key = id;
        const data = rawData[key];
        const currentIdx = currentResponseIndex[key]; // Nombre de réponses à afficher (1, 2, 3...)
        const totalResponses = data.length;
        const responseToShowIndex = currentIdx - 1; // Index dans le tableau (0, 1, 2...)

        let content = `
            <div style="max-height:90%; overflow-y:auto;">
                <h2>Zone ${zone} - Question ${question}</h2>
                <hr style="color: #fff;">
        `;
        
        // --- AFFICHAGE DE LA RÉPONSE EN COURS SEULEMENT ---
        if (currentIdx > 0 && responseToShowIndex < totalResponses) {
            // Affiche uniquement la réponse correspondant à l'index actuel
            content += `<p style="font-weight: bold; color: #fff;">
                            ${currentIdx.toLocaleString()}. ${data[responseToShowIndex]}
                        </p>`;
        } else if (currentIdx === 0 && totalResponses > 0) {
            // Afficher un message de démarrage si aucune réponse n'est encore affichée
            content += `<p style="font-style: italic; color: #aaa;">
                            Cliquez sur "Afficher Réponse" pour commencer.
                        </p>`;
        } else if (totalResponses === 0) {
             content += `<p style="font-style: italic; color: #aaa;">
                            Aucune réponse enregistrée pour cette question.
                        </p>`;
        }
        
        content += `</div>`;
        
        // --- BOUTONS D'ACTION SUR LA DIAPO ---
        content += `<div style="margin-top: 30px;">`;

        // 1. Bouton "Afficher la réponse précédente"
        if (currentIdx > 1) {
            content += `<button class="btn btn-warning me-3" onclick="handleResponseNavigation('${key}', -1)">Réponse Précédente</button>`;
        }
        
        // 2. Bouton "Afficher la réponse suivante"
        if (currentIdx < totalResponses) {
            content += `<button class="btn btn-success" onclick="handleResponseNavigation('${key}', 1)">Afficher Réponse ${currentIdx + 1}/${totalResponses}</button>`;
        } else {
            content += `<p class="text-success mt-2" style="font-weight: bold;">Toutes les ${totalResponses} réponses affichées.</p>`;
        }

        content += `</div>`;
        
        return `<div class="slide-item">${content}</div>`;
    }
    
    return `<div class="slide-item"><h1>Erreur de type de slide.</h1></div>`;
}

/**
 * Affiche la slide à l'index 'currentSlide' en générant son HTML.
 */
function displayCurrentSlide() {
    const contentContainer = document.getElementById("diapo-content");
    
    if (slideDefinitions.length === 0) {
        contentContainer.innerHTML = `<div class="slide-item"><h1>[Aucune donnée disponible]</h1></div>`;
        return;
    }
    
    // 1. Début de la transition
    contentContainer.style.opacity = 0; 
    
    setTimeout(() => {
        // Génère le HTML au moment de l'affichage
        contentContainer.innerHTML = generateSlideHTML(slideDefinitions[currentSlide]);

        // 2. Rétablit l'opacité
        contentContainer.style.opacity = 1;

    }, TRANSITION_DURATION_MS); 
}

/**
 * Gère le défilement des index de réponses sur la diapositive actuelle.
 */
function handleResponseNavigation(key, direction) {
    if (currentResponseIndex[key] === undefined) return;
    
    const totalResponses = rawData[key].length;
    let newIndex = currentResponseIndex[key] + direction; // newIndex représente le NOMBRE de réponses à afficher

    // S'assurer que le nouvel index est dans les limites [0, totalResponses]
    if (newIndex >= 0 && newIndex <= totalResponses) {
        currentResponseIndex[key] = newIndex;
        
        // Re-afficher la slide actuelle avec le nouvel index de réponse
        displayCurrentSlide();
    }
}

/**
 * Gère le défilement des slides (manuellement).
 * @param {number} direction - 1 pour Suivant, -1 pour Précédent.
 */
function navigateSlide(direction) {
    if (slideDefinitions.length === 0) return;
    
    // Calcul du nouvel index de slide avec gestion du bouclage
    currentSlide = (currentSlide + direction + slideDefinitions.length) % slideDefinitions.length;

    displayCurrentSlide();
}

/**
 * Fonction appelée par les boutons de navigation externes.
 */
function handleManualNavigation(direction) {
    // 1. Met à jour les définitions (pour voir si de nouvelles questions sont apparues)
    generateSlideDefinitions(); 
    
    // 2. Navigue vers la slide demandée
    navigateSlide(direction);
}


// --- INITIALISATION ---

// 1. Premier chargement : récupération des définitions et données.
generateSlideDefinitions();

// 2. Affichage de la première slide.
displayCurrentSlide();
</script>
</body>
</html>